<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบอบรมออนไลน์</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for better typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Sarabun', sans-serif;
        }
        /* Custom class to hide elements */
        .hidden {
            display: none;
        }
        /* Style for the video container to maintain aspect ratio */
        .video-container {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
            max-width: 100%;
            background: #000;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        /* Modal styles */
        .modal {
            background-color: rgba(0, 0, 0, 0.7);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-600">ระบบอบรมออนไลน์</h1>
            <p class="text-gray-600 mt-2">กรุณากรอกข้อมูลและทำแบบทดสอบให้ครบถ้วน</p>
        </header>

        <!-- Page 1: Registration Form -->
        <div id="page-register">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 text-center">ลงทะเบียนเข้ารับการอบรม</h2>
                <form id="register-form">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="firstName" class="block text-sm font-medium text-gray-700">ชื่อ</label>
                            <input type="text" id="firstName" name="firstName" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="lastName" class="block text-sm font-medium text-gray-700">นามสกุล</label>
                            <input type="text" id="lastName" name="lastName" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="position" class="block text-sm font-medium text-gray-700">ตำแหน่ง</label>
                            <input type="text" id="position" name="position" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="employeeId" class="block text-sm font-medium text-gray-700">รหัสพนักงาน</label>
                            <input type="text" id="employeeId" name="employeeId" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div class="md:col-span-2">
                            <label for="trainingDate" class="block text-sm font-medium text-gray-700">เลือกวันที่อบรม</label>
                            <input type="date" id="trainingDate" name="trainingDate" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                    </div>
                    <div class="mt-8 text-center">
                        <button type="submit" class="w-full md:w-auto inline-flex justify-center py-3 px-12 border border-transparent shadow-sm text-lg font-medium rounded-full text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                            ถัดไป
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Page 2: Course Selection & Video Player -->
        <div id="page-course" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 text-center">เลือกหลักสูตรและรับชมวิดีโอ</h2>
                <div id="course-selection">
                    <p class="text-center mb-4">กรุณาเลือกหลักสูตรที่ต้องการอบรม</p>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ชื่อหลักสูตร</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ระยะเวลา</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">เลือก</th>
                                </tr>
                            </thead>
                            <tbody id="course-table-body" class="bg-white divide-y divide-gray-200">
                                <!-- Course rows will be injected by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div id="video-player-section" class="hidden mt-8">
                    <h3 id="video-title" class="text-xl font-bold mb-4 text-center"></h3>
                    <div class="video-container rounded-lg shadow-inner">
                        <div id="player"></div>
                    </div>
                    <p class="text-center text-sm text-red-600 mt-4">**ไม่สามารถเลื่อนหรือข้ามวิดีโอได้ กรุณารับชมจนจบ**</p>
                </div>
            </div>
        </div>

        <!-- In-Video Quiz Modal -->
        <div id="in-video-quiz-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal">
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full mx-4">
                <h3 class="text-xl font-bold mb-4">คำถามระหว่างรับชม</h3>
                <div id="in-video-quiz-content">
                    <!-- In-video quiz question and options will be injected here -->
                </div>
                <button id="submit-in-video-answer" class="mt-6 w-full py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">ส่งคำตอบ</button>
            </div>
        </div>
        
        <!-- Page 3: Post-Training Quiz -->
        <div id="page-post-quiz" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 text-center">แบบทดสอบหลังการอบรม</h2>
                <form id="post-quiz-form">
                    <div id="post-quiz-questions" class="space-y-8">
                        <!-- Post-quiz questions will be injected here -->
                    </div>
                    <div class="mt-8 text-center">
                        <button type="submit" class="w-full md:w-auto inline-flex justify-center py-3 px-12 border border-transparent shadow-sm text-lg font-medium rounded-full text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-colors">
                            ส่งแบบทดสอบ
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Page 4: Results -->
        <div id="page-results" class="hidden">
            <div class="bg-white p-8 rounded-xl shadow-lg text-center">
                <h2 class="text-2xl font-bold mb-4">ผลการอบรม</h2>
                <div id="result-pass" class="hidden">
                    <svg class="mx-auto h-16 w-16 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h3 class="text-3xl font-bold text-green-600 mt-4">ยินดีด้วย! คุณผ่านการอบรม</h3>
                </div>
                <div id="result-fail" class="hidden">
                     <svg class="mx-auto h-16 w-16 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h3 class="text-3xl font-bold text-red-600 mt-4">ไม่ผ่านการอบรม</h3>
                    <p class="text-gray-600 mt-2">กรุณาติดต่อผู้ดูแลเพื่อทำการอบรมอีกครั้ง</p>
                </div>
                <p class="text-xl mt-6">คะแนนของคุณคือ: <span id="final-score" class="font-bold">0</span> / 10</p>
                <p class="text-gray-500 mt-4">ระบบได้บันทึกผลของท่านเรียบร้อยแล้ว</p>
            </div>
        </div>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="hidden fixed inset-0 z-50 flex items-center justify-center modal">
            <div class="animate-spin rounded-full h-32 w-32 border-t-4 border-b-4 border-blue-500"></div>
        </div>

    </div>

    <!-- YouTube IFrame Player API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // --- CONFIGURATION ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyG7JvoFs7Nw55eEPjvy1r-z8sVmfSWkAZ-mfkC1OrjkT4RF3DneACSFg0ljmConYub/exec"; // <-- ❗ PASTE YOUR GOOGLE APPS SCRIPT URL HERE

        // --- DATA & STATE ---
        let userData = {};
        let player;
        let selectedCourse;
        let inVideoQuizTriggered = [false, false, false, false, false];
        let currentInVideoQuestionIndex = 0;
        let postQuizScore = 0;
        let antiSeekInterval;

        // --- MOCK DATA (Replace with your actual course data) ---
        const courses = [
            { id: 'course01', name: 'ความปลอดภัยในการทำงานเบื้องต้น', videoId: '2vxPtfq4e7Y', duration: 480, inVideoQuiz: [
                { time: 200, question: 'อุปกรณ์ป้องกันส่วนบุคคลเรียกว่าอะไร?', options: ['PPE', 'ABC', 'Safety First'], answer: 'PPE' },
                { time: 240, question: 'ข้อใดคือสาเหตุหลักของอุบัติเหตุ?', options: ['ความประมาท', 'เครื่องจักร', 'สภาพแวดล้อม'], answer: 'ความประมาท' },
                { time: 280, question: 'ป้ายสีแดงหมายถึงอะไร?', options: ['หยุด', 'ระวัง', 'ปลอดภัย'], answer: 'หยุด' },
                { time: 320, question: 'หากเกิดไฟไหม้ควรทำอย่างไรก่อน?', options: ['ตะโกน', 'กดสัญญาณเตือน', 'วิ่งหนี'], answer: 'กดสัญญาณเตือน' },
                { time: 360, question: 'เบอร์โทรฉุกเฉินคือเบอร์อะไร?', options: ['191', '1669', '199'], answer: '199' }
            ], postQuiz: [
                { question: 'ข้อ 1: คำถามทดสอบหลังเรียน', options: ['A', 'B', 'C'], answer: 'A' },
                { question: 'ข้อ 2: คำถามทดสอบหลังเรียน', options: ['A', 'B', 'C'], answer: 'B' },
                { question: 'ข้อ 3: คำถามทดสอบหลังเรียน', options: ['A', 'B', 'C'], answer: 'C' },
                { question: 'ข้อ 4: คำถามทดสอบหลังเรียน', options: ['A', 'B', 'C'], answer: 'A' },
                { question: 'ข้อ 5: คำถามทดสอบหลังเรียน', options: ['A', 'B', 'C'], answer: 'B' },
                { question: 'ข้อ 6: คำถามทดสอบหลังเรียน', options: ['A', 'B', 'C'], answer: 'C' },
                { question: 'ข้อ 7: คำถามทดสอบหลังเรียน', options: ['A', 'B', 'C'], answer: 'A' },
                { question: 'ข้อ 8: คำถามทดสอบหลังเรียน', options: ['A', 'B', 'C'], answer: 'B' },
                { question: 'ข้อ 9: คำถามทดสอบหลังเรียน', options: ['A', 'B', 'C'], answer: 'C' },
                { question: 'ข้อ 10: คำถามทดสอบหลังเรียน', options: ['A', 'B', 'C'], answer: 'A' }
            ]},
            { id: 'course02', name: 'การปฐมพยาบาลเบื้องต้น (CPR)', videoId: 'Lur_4E9A3lI', duration: 600, inVideoQuiz: [], postQuiz: [] }
        ];

        // --- DOM ELEMENTS ---
        const pages = {
            register: document.getElementById('page-register'),
            course: document.getElementById('page-course'),
            postQuiz: document.getElementById('page-post-quiz'),
            results: document.getElementById('page-results')
        };
        const registerForm = document.getElementById('register-form');
        const postQuizForm = document.getElementById('post-quiz-form');
        const loadingSpinner = document.getElementById('loading-spinner');
        const courseTableBody = document.getElementById('course-table-body');
        const videoPlayerSection = document.getElementById('video-player-section');
        const videoTitle = document.getElementById('video-title');
        const inVideoQuizModal = document.getElementById('in-video-quiz-modal');
        const inVideoQuizContent = document.getElementById('in-video-quiz-content');
        const submitInVideoAnswerBtn = document.getElementById('submit-in-video-answer');


        // --- FUNCTIONS ---

        function checkScriptURL() {
            if (SCRIPT_URL === "YOUR_WEB_APP_URL" || !SCRIPT_URL) {
                alert("ข้อผิดพลาด: กรุณากำหนดค่า SCRIPT_URL ในโค้ด HTML ก่อนใช้งาน\nโปรดคัดลอก URL ของ Web App จาก Google Apps Script มาวาง");
                return false;
            }
            return true;
        }

        function showPage(pageId) {
            Object.values(pages).forEach(page => page.classList.add('hidden'));
            if (pages[pageId]) {
                pages[pageId].classList.remove('hidden');
            }
        }

        function toggleLoading(show) {
            loadingSpinner.classList.toggle('hidden', !show);
        }

        function populateCourses() {
            courseTableBody.innerHTML = ''; // Clear existing rows
            courses.forEach(course => {
                const row = `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">${course.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${Math.floor(course.duration / 60)} นาที</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <button onclick="selectCourse('${course.id}')" class="text-white bg-blue-600 hover:bg-blue-700 font-medium rounded-lg text-sm px-5 py-2.5">เลือก</button>
                        </td>
                    </tr>
                `;
                courseTableBody.innerHTML += row;
            });
        }

        function selectCourse(courseId) {
            if (!checkScriptURL()) return;

            selectedCourse = courses.find(c => c.id === courseId);
            if (!selectedCourse) return;

            userData.courseName = selectedCourse.name;

            // Update Google Sheet with selected course
            const dataToUpdate = { ...userData, action: 'register' };
            toggleLoading(true);
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Use no-cors for simple requests
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToUpdate)
            })
            .then(() => {
                document.getElementById('course-selection').classList.add('hidden');
                videoPlayerSection.classList.remove('hidden');
                videoTitle.textContent = selectedCourse.name;
                if (player) {
                    player.loadVideoById(selectedCourse.videoId);
                } else {
                    // This function is required by the YouTube API script
                    window.onYouTubeIframeAPIReady = function() {
                        player = new YT.Player('player', {
                            height: '390',
                            width: '640',
                            videoId: selectedCourse.videoId,
                            playerVars: {
                                'playsinline': 1,
                                'controls': 0, // Disable default controls
                                'disablekb': 1, // Disable keyboard controls
                                'modestbranding': 1,
                                'rel': 0 // Do not show related videos
                            },
                            events: {
                                'onReady': onPlayerReady,
                                'onStateChange': onPlayerStateChange
                            }
                        });
                    }
                    // Manually call if API is already loaded
                    if (window.YT && window.YT.Player) {
                        onYouTubeIframeAPIReady();
                    }
                }
            })
            .catch(error => {
                console.error('Error updating course:', error);
                alert('เกิดข้อผิดพลาดในการเลือกหลักสูตร');
            })
            .finally(() => {
                toggleLoading(false);
            });
        }
        
        function onPlayerReady(event) {
            event.target.playVideo();
            // Start the anti-seek and quiz-check interval
            let lastTime = -1;
            antiSeekInterval = setInterval(() => {
                if (player && typeof player.getCurrentTime === 'function') {
                    const currentTime = player.getCurrentTime();
                    
                    // Anti-seek logic
                    if (lastTime !== -1 && currentTime > lastTime + 2) { // 2s buffer
                        player.seekTo(lastTime, true);
                    }
                    lastTime = currentTime;

                    // In-video quiz logic
                    const videoDuration = player.getDuration();
                    if (videoDuration > 0 && (videoDuration - currentTime) <= 300) { // Last 5 minutes
                        checkAndTriggerInVideoQuiz(currentTime, videoDuration);
                    }
                }
            }, 1000);
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                clearInterval(antiSeekInterval); // Stop checking when video ends
                showPage('postQuiz');
                populatePostQuiz();
            }
        }

        function checkAndTriggerInVideoQuiz(currentTime, duration) {
            const quizStartTime = duration - 300; // 5 minutes from the end
            selectedCourse.inVideoQuiz.forEach((quiz, index) => {
                // Check if the current time is past the quiz trigger time AND it hasn't been triggered yet
                if (currentTime >= quiz.time && !inVideoQuizTriggered[index]) {
                    inVideoQuizTriggered[index] = true; // Mark as triggered
                    currentInVideoQuestionIndex = index;
                    player.pauseVideo();
                    displayInVideoQuiz(quiz);
                }
            });
        }

        function displayInVideoQuiz(quiz) {
            let optionsHTML = '';
            quiz.options.forEach((option, index) => {
                optionsHTML += `
                    <label class="block mt-2">
                        <input type="radio" name="in-video-option" value="${option}" class="mr-2">
                        ${option}
                    </label>
                `;
            });
            inVideoQuizContent.innerHTML = `
                <p class="font-semibold">${quiz.question}</p>
                ${optionsHTML}
            `;
            inVideoQuizModal.classList.remove('hidden');
        }

        function populatePostQuiz() {
            const questionsContainer = document.getElementById('post-quiz-questions');
            let questionsHTML = '';
            selectedCourse.postQuiz.forEach((q, index) => {
                let optionsHTML = '';
                q.options.forEach(option => {
                    optionsHTML += `
                        <label class="block mt-2">
                            <input type="radio" name="question-${index}" value="${option}" required class="mr-2">
                            ${option}
                        </label>
                    `;
                });
                questionsHTML += `
                    <div>
                        <p class="font-semibold">${index + 1}. ${q.question}</p>
                        <div class="mt-2 pl-4">${optionsHTML}</div>
                    </div>
                `;
            });
            questionsContainer.innerHTML = questionsHTML;
        }

        // --- EVENT LISTENERS ---
        document.addEventListener('DOMContentLoaded', () => {
            showPage('register');
            populateCourses();
        });

        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!checkScriptURL()) return;

            toggleLoading(true);
            const formData = new FormData(registerForm);
            userData = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                position: formData.get('position'),
                employeeId: formData.get('employeeId'),
                trainingDate: formData.get('trainingDate'),
            };
            // We register the user first, then update with the course later.
            // This ensures we have a record even if they don't select a course.
            const dataToSend = { ...userData, action: 'register', courseName: '' };

            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors', // Important for simple requests to Apps Script
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dataToSend)
            })
            .then(() => {
                showPage('course');
            })
            .catch(error => {
                console.error('Error:', error);
                alert('เกิดข้อผิดพลาดในการลงทะเบียน กรุณาลองใหม่อีกครั้ง');
            })
            .finally(() => {
                toggleLoading(false);
            });
        });
        
        submitInVideoAnswerBtn.addEventListener('click', () => {
            const selectedOption = document.querySelector('input[name="in-video-option"]:checked');
            if (!selectedOption) {
                alert('กรุณาเลือกคำตอบ');
                return;
            }
            // You can optionally add scoring for in-video quizzes here
            inVideoQuizModal.classList.add('hidden');
            player.playVideo();
        });

        postQuizForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!checkScriptURL()) return;
            
            toggleLoading(true);
            postQuizScore = 0;
            const formData = new FormData(postQuizForm);
            selectedCourse.postQuiz.forEach((q, index) => {
                if (formData.get(`question-${index}`) === q.answer) {
                    postQuizScore++;
                }
            });

            const passStatus = postQuizScore >= 8 ? 'ผ่าน (Passed)' : 'ไม่ผ่าน (Failed)';
            
            // Display results locally first
            document.getElementById('final-score').textContent = postQuizScore;
            if (passStatus === 'ผ่าน (Passed)') {
                document.getElementById('result-pass').classList.remove('hidden');
                document.getElementById('result-fail').classList.add('hidden');

            } else {
                document.getElementById('result-fail').classList.remove('hidden');
                document.getElementById('result-pass').classList.add('hidden');
            }
            
            // Send score to Google Sheet
            const scoreData = {
                action: 'submitScore',
                employeeId: userData.employeeId,
                score: postQuizScore,
                status: passStatus
            };

            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(scoreData)
            })
            .then(() => {
                showPage('results');
            })
            .catch(error => {
                console.error('Error submitting score:', error);
                alert('เกิดข้อผิดพลาดในการบันทึกคะแนน');
            })
            .finally(() => {
                toggleLoading(false);
            });
        });
    </script>
</body>
</html>

